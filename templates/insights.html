{% extends "base.html" %}

{% block title %}Insights - Competitor Monitor{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="bi bi-lightbulb me-2"></i>Competitive Insights</h2>
            <p class="text-muted mb-0">AI-powered analysis with team-specific recommendations</p>
        </div>
        <div class="d-flex gap-2">
            <div class="btn-group">
                <button class="btn btn-outline-success dropdown-toggle" data-bs-toggle="dropdown">
                    <i class="bi bi-download"></i> Export
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="/api/export/insights/pdf"><i class="bi bi-file-pdf text-danger"></i> Export as PDF</a></li>
                    <li><a class="dropdown-item" href="/api/export/insights/csv"><i class="bi bi-file-earmark-spreadsheet text-success"></i> Export as CSV</a></li>
                </ul>
            </div>
            <button class="btn btn-primary" onclick="generateInsights()">
                <i class="bi bi-magic me-1"></i> Generate Insights
            </button>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4" id="summary-cards">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h6 class="card-title">Total Insights</h6>
                    <h2 id="total-insights">-</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-dark">
                <div class="card-body">
                    <h6 class="card-title">Pending Review</h6>
                    <h2 id="unreviewed-insights">-</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body">
                    <h6 class="card-title">Urgent</h6>
                    <h2 id="urgent-insights">-</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h6 class="card-title">High Impact</h6>
                    <h2 id="high-impact-insights">-</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Team Filter Tabs -->
    <ul class="nav nav-tabs mb-4" id="teamTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="all-tab" data-bs-toggle="tab" data-team="" type="button">
                <i class="bi bi-grid me-1"></i> All Teams
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="sales-tab" data-bs-toggle="tab" data-team="sales" type="button">
                <i class="bi bi-graph-up me-1"></i> Sales
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="marketing-tab" data-bs-toggle="tab" data-team="marketing" type="button">
                <i class="bi bi-megaphone me-1"></i> Marketing
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="product-tab" data-bs-toggle="tab" data-team="product" type="button">
                <i class="bi bi-box me-1"></i> Product
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="engineering-tab" data-bs-toggle="tab" data-team="engineering" type="button">
                <i class="bi bi-cpu me-1"></i> Engineering
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="executive-tab" data-bs-toggle="tab" data-team="executive" type="button">
                <i class="bi bi-briefcase me-1"></i> Executive
            </button>
        </li>
    </ul>

    <!-- Insights List -->
    <div id="insights-list">
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>
</div>

<!-- Generate Insights Modal -->
<div class="modal fade" id="generateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Generate Insights</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>This will analyze unprocessed alerts and news to generate team-specific insights and product comparisons.</p>
                <div class="mb-3">
                    <label class="form-label">Number of items to process</label>
                    <input type="number" class="form-control" id="generateLimit" value="10" min="1" max="50">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="runGenerateInsights()">
                    <i class="bi bi-magic me-1"></i> Generate
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentTeam = '';

document.addEventListener('DOMContentLoaded', function() {
    loadSummary();
    loadInsights();
    
    // Tab click handlers
    document.querySelectorAll('#teamTabs button').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('#teamTabs button').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentTeam = this.dataset.team;
            loadInsights();
        });
    });
});

function loadSummary() {
    fetch('/api/insights/summary')
        .then(r => r.json())
        .then(data => {
            document.getElementById('total-insights').textContent = data.total;
            document.getElementById('unreviewed-insights').textContent = data.unreviewed;
            document.getElementById('urgent-insights').textContent = data.urgent;
            document.getElementById('high-impact-insights').textContent = data.high_impact_recent.length;
        });
}

function loadInsights() {
    let url = '/api/insights';
    if (currentTeam) {
        url += `?team=${currentTeam}`;
    }
    
    fetch(url)
        .then(r => r.json())
        .then(data => {
            renderInsights(data.insights);
        });
}

function renderInsights(insights) {
    const container = document.getElementById('insights-list');
    
    if (!insights || insights.length === 0) {
        container.innerHTML = `
            <div class="text-center py-5">
                <i class="bi bi-lightbulb display-1 text-muted"></i>
                <h4 class="mt-3">No Insights Yet</h4>
                <p class="text-muted">Click "Generate Insights" to analyze competitor news and create team recommendations.</p>
            </div>
        `;
        return;
    }
    
    let html = '<div class="row">';
    
    insights.forEach(insight => {
        const urgencyClass = insight.urgency_score >= 70 ? 'danger' : (insight.urgency_score >= 40 ? 'warning' : 'info');
        const impactClass = insight.impact_score >= 70 ? 'danger' : (insight.impact_score >= 40 ? 'warning' : 'info');
        
        html += `
        <div class="col-12 mb-4">
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0">${escapeHtml(insight.title)}</h5>
                        <small class="text-muted">
                            ${insight.competitor_name || 'Unknown'} â€¢ 
                            ${new Date(insight.created_at).toLocaleDateString()}
                        </small>
                    </div>
                    <div>
                        <span class="badge bg-${urgencyClass} me-1">Urgency: ${insight.urgency_score}</span>
                        <span class="badge bg-${impactClass}">Impact: ${insight.impact_score}</span>
                        ${insight.is_reviewed ? '<span class="badge bg-success ms-1"><i class="bi bi-check"></i> Reviewed</span>' : ''}
                    </div>
                </div>
                <div class="card-body">
                    <p class="lead">${escapeHtml(insight.executive_summary || '')}</p>
                    
                    ${insight.competitor_product && insight.fluke_product ? `
                    <div class="alert alert-info">
                        <strong><i class="bi bi-arrow-left-right me-1"></i> Product Comparison:</strong>
                        ${escapeHtml(insight.competitor_product)} vs Fluke ${escapeHtml(insight.fluke_product)}
                        <br><small>${escapeHtml(insight.comparison_summary || '')}</small>
                    </div>
                    ` : ''}
                    
                    ${currentTeam && insight.team_insights ? renderTeamInsights(currentTeam, insight.team_insights) : renderAllTeamsSummary(insight)}
                    
                    <div class="mt-3">
                        <a href="/insights/${insight.id}" class="btn btn-primary">
                            <i class="bi bi-eye me-1"></i> View Full Analysis
                        </a>
                    </div>
                </div>
            </div>
        </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

function renderTeamInsights(team, teamData) {
    if (!teamData || !teamData.summary) return '';
    
    const teamNames = {
        'sales': 'Sales Team',
        'marketing': 'Marketing Team', 
        'product': 'Product Team',
        'engineering': 'Engineering Team',
        'executive': 'Executive Team'
    };
    
    const urgencyColors = {
        'high': 'danger',
        'medium': 'warning',
        'low': 'info'
    };
    
    return `
    <div class="card bg-light mt-3">
        <div class="card-header">
            <strong><i class="bi bi-people me-1"></i> ${teamNames[team] || team}</strong>
            ${teamData.urgency ? `<span class="badge bg-${urgencyColors[teamData.urgency] || 'secondary'} float-end">${teamData.urgency} urgency</span>` : ''}
        </div>
        <div class="card-body">
            <p>${escapeHtml(teamData.summary || '')}</p>
            
            ${teamData.talking_points ? `
            <strong>Talking Points:</strong>
            <ul>${teamData.talking_points.map(p => `<li>${escapeHtml(p)}</li>`).join('')}</ul>
            ` : ''}
            
            ${teamData.messaging_recommendations ? `
            <strong>Messaging Recommendations:</strong>
            <ul>${teamData.messaging_recommendations.map(p => `<li>${escapeHtml(p)}</li>`).join('')}</ul>
            ` : ''}
            
            ${teamData.feature_gaps ? `
            <strong>Feature Gaps:</strong>
            <ul>${teamData.feature_gaps.map(p => `<li>${escapeHtml(p)}</li>`).join('')}</ul>
            ` : ''}
            
            ${teamData.strategic_implications ? `
            <strong>Strategic Implications:</strong>
            <p>${escapeHtml(teamData.strategic_implications)}</p>
            ` : ''}
        </div>
    </div>
    `;
}

function renderAllTeamsSummary(insight) {
    const teams = [
        { key: 'sales_insights', name: 'Sales', icon: 'graph-up' },
        { key: 'marketing_insights', name: 'Marketing', icon: 'megaphone' },
        { key: 'product_insights', name: 'Product', icon: 'box' },
        { key: 'engineering_insights', name: 'Engineering', icon: 'cpu' },
        { key: 'executive_insights', name: 'Executive', icon: 'briefcase' }
    ];
    
    let html = '<div class="row mt-3">';
    
    teams.forEach(team => {
        const data = insight[team.key];
        if (data && data.summary) {
            const urgencyColors = { 'high': 'danger', 'medium': 'warning', 'low': 'info' };
            html += `
            <div class="col-md-4 mb-2">
                <div class="card h-100">
                    <div class="card-body p-3">
                        <h6><i class="bi bi-${team.icon} me-1"></i> ${team.name}</h6>
                        <small class="text-muted">${escapeHtml(data.summary.substring(0, 100))}...</small>
                        ${data.urgency ? `<span class="badge bg-${urgencyColors[data.urgency] || 'secondary'} mt-2">${data.urgency}</span>` : ''}
                    </div>
                </div>
            </div>
            `;
        }
    });
    
    html += '</div>';
    return html;
}

function generateInsights() {
    new bootstrap.Modal(document.getElementById('generateModal')).show();
}

function runGenerateInsights() {
    const limit = document.getElementById('generateLimit').value;
    const btn = event.target;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Generating...';
    
    fetch('/api/insights/generate-batch', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ limit: parseInt(limit) })
    })
    .then(r => r.json())
    .then(data => {
        bootstrap.Modal.getInstance(document.getElementById('generateModal')).hide();
        if (data.success) {
            alert(`Generated ${data.count} insights!`);
            loadSummary();
            loadInsights();
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(err => {
        alert('Error generating insights: ' + err);
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-magic me-1"></i> Generate';
    });
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}
